<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
  <title>СОНП — Участник</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --bg:#f6f8fb;
      --card:#ffffff;
      --text:#101827;
      --muted:#5c6b86;
      --accent:#2b74ff;
      --accent-soft:#eaf0ff;
      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#ef4444;
      --radius:18px;
      --shadow:0 14px 36px rgba(15,23,42,.12);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:radial-gradient(circle at top,#edf2ff 0,#f6f8fb 40%,#f6f8fb 100%);
      color:var(--text);
      padding:20px;
    }
    .screen{
      display:none;
      max-width:760px;
      margin:0 auto;
      min-height:calc(100dvh - 40px);
    }
    .screen.active{display:block}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px 20px;
      margin:12px 0;
      border:1px solid rgba(15,23,42,.03);
    }
    h1{margin:4px 0 2px;font-size:1.9rem;letter-spacing:.02em}
    h2{margin:0 0 4px}
    h3{margin:0 0 6px}
    .muted{color:var(--muted)}
    label{display:block;margin:10px 0 6px;font-weight:600;font-size:.95rem}
    input[type="text"]{
      width:100%;
      padding:14px 14px;
      border-radius:12px;
      border:1.5px solid #e3e9f5;
      font-size:16px;
      outline:none;
      transition:border-color .18s, box-shadow .18s, background .18s;
      background:#fdfdff;
    }
    input[type="text"]:focus{
      border-color:#c7d6ff;
      box-shadow:0 0 0 4px #eaf0ff;
      background:#ffffff;
    }
    .btn{
      appearance:none;
      border:0;
      border-radius:12px;
      padding:14px 16px;
      background:var(--accent);
      color:#fff;
      font-weight:800;
      cursor:pointer;
      font-size:.98rem;
      letter-spacing:.04em;
      text-transform:uppercase;
      box-shadow:0 10px 24px rgba(37,99,235,.35);
      transition:transform .12s, box-shadow .12s, opacity .12s, background .12s;
    }
    .btn:hover{transform:translateY(-1px);box-shadow:0 14px 32px rgba(37,99,235,.38);}
    .btn:active{transform:translateY(1px);box-shadow:0 6px 14px rgba(37,99,235,.25);}
    .btn.ghost{
      background:#fff;
      color:var(--accent);
      border:2px solid var(--accent);
      box-shadow:none;
      text-transform:none;
      letter-spacing:0;
    }
    .btn:disabled{opacity:.6;cursor:not-allowed;box-shadow:none;transform:none}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .top{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .pill{
      background:#eef2ff;
      color:#1e3a8a;
      border-radius:999px;
      padding:6px 12px;
      font-weight:800;
      border:1px solid #c7d2fe;
      font-size:.88rem;
      white-space:nowrap;
    }
    .pill.timer{
      background:#0f172a;
      color:#fbbf24;
      border-color:#111827;
      font-variant-numeric:tabular-nums;
      box-shadow:0 0 0 1px rgba(15,23,42,.7), 0 0 18px rgba(251,191,36,.4);
    }
    ul{margin:0;padding-left:18px}
    li{margin:2px 0}

    /* JOIN */
    .brand-mark{
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .brand-logo{
      width:32px;height:32px;border-radius:12px;
      background:radial-gradient(circle at 25% 0,#f97316 0,#eab308 30%,#0ea5e9 70%,#1d4ed8 100%);
      box-shadow:0 0 0 2px rgba(255,255,255,.9),0 10px 22px rgba(30,64,175,.55);
      position:relative;
      overflow:hidden;
    }
    .brand-logo::before{
      content:'Σ';
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      color:#0b1120;
    }

    /* QUESTION BASIC */
    .answers{display:grid;gap:10px;margin-top:10px}
    .opt{
      width:100%;
      text-align:left;
      padding:14px;
      border-radius:14px;
      border:1.5px solid #e5e7f2;
      background:#ffffff;
      font-weight:600;
      cursor:pointer;
      font-size:.96rem;
      transition:border-color .15s, box-shadow .15s, transform .08s, background .15s;
    }
    .opt span.label{
      display:inline-block;
      min-width:26px;
      text-align:center;
      margin-right:6px;
      padding:3px 0;
      border-radius:999px;
      background:#eef2ff;
      color:#3730a3;
      font-weight:800;
      font-size:.8rem;
    }
    .opt:hover{
      border-color:#c7d2fe;
      box-shadow:0 6px 16px rgba(148,163,255,.35);
      transform:translateY(-1px);
    }
    .opt.selected{
      border-color:#4f46e5;
      box-shadow:0 0 0 2px rgba(79,70,229,.45);
      background:#eef2ff;
    }

    #textBox input[type="text"]{
      background:#f9fafb;
    }

    /* CARD VISUAL BASE (вертикальный формат) */
    .card-visual{
      margin:16px 0 10px;
      padding:20px 20px 18px;
      border-radius:20px;
      color:#e5edff;
      position:relative;
      overflow:hidden;
      background:radial-gradient(circle at -10% -20%,#4f46e5 0,#0f172a 45%,#020617 100%);
      border:1px solid rgba(148,163,255,.5);
      display:flex;
      flex-direction:column;
      min-height:260px;
    }
    .card-visual-header{
      font-size:.8rem;
      text-transform:uppercase;
      letter-spacing:.16em;
      opacity:.8;
      margin-bottom:6px;
    }
    .card-visual-title{
      font-weight:700;
      font-size:1.05rem;
      margin-bottom:10px;
    }

    /* Общий блок ввода внутри карточек */
    .card-input{
      margin-top:auto;
      padding:10px 10px 12px;
      border-radius:14px;
      background:rgba(15,23,42,.88);
      border:1px solid rgba(148,163,255,.7);
    }
    .card-input textarea{
      width:100%;
      min-height:80px;
      resize:vertical;
      border-radius:10px;
      border:1px solid #e5e7eb;
      padding:8px 10px;
      font-size:.9rem;
      font-family:inherit;
      outline:none;
    }
    .card-input textarea:focus{
      border-color:#c7d2fe;
      box-shadow:0 0 0 3px rgba(129,140,248,.25);
      background:#020617;
      color:#e5e7eb;
    }
    .card-input .btn{
      margin-top:8px;
      padding:10px 14px;
      font-size:.85rem;
      text-transform:none;
      letter-spacing:.02em;
      box-shadow:0 8px 20px rgba(79,70,229,.5);
    }

    /* FISH — ромбовидные рыбы как на карточке */
    .card-visual--fish_odd_one_out{
      background:linear-gradient(180deg,#0ea5e9,#1d4ed8);
    }
    .fish-list{
      display:flex;
      flex-direction:column;
      gap:20px;
      margin-top:4px;
    }
    .fish-row{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .fish-row--left{
      justify-content:flex-start;
    }
    .fish-row--right{
      justify-content:flex-end;
    }
    .fish-label{
      font-size:.8rem;
      font-weight:700;
      color:#bfdbfe;
      min-width:64px;
    }
    .fish-arrow{
      width:0;
      height:0;
      border-top:10px solid transparent;
      border-bottom:10px solid transparent;
      border-left:16px solid #f97316;
      filter:drop-shadow(0 0 4px rgba(15,23,42,.4));
    }
    .fish-row--right .fish-arrow{
      transform:scaleX(-1);
    }
    .fish-figure{
      position:relative;
      width:140px;
      height:86px;
      flex:0 0 140px;
      transition:transform .2s;
      margin:0 12px;
    }
    .fish-figure--left{
      transform:translateX(-10px);
    }
    .fish-figure--right{
      transform:translateX(10px);
    }
    .fish-figure[data-dir="right"]::before,
    .fish-figure[data-dir="left"]::before{
      content:'';
      position:absolute;
      top:50%;
      transform:translateY(-50%);
      width:0;
      height:0;
      border-top:20px solid transparent;
      border-bottom:20px solid transparent;
    }
    .fish-figure[data-dir="right"]::before{
      left:-13px;
      border-left:26px solid #f97316;
      border-right:none;
    }
    .fish-figure[data-dir="left"]::before{
      right:-13px;
      border-right:26px solid #f97316;
      border-left:none;
    }
    .fish-head{
      position:absolute;
      top:50%;
      width:32px;
      height:32px;
      border-radius:9px;
      background:#f973a0;
      transform:translateY(-50%);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 2px rgba(248,250,252,.9);
    }
    .fish-figure[data-dir="right"] .fish-head{right:-4px;}
    .fish-figure[data-dir="left"] .fish-head{left:-4px;}
    .fish-eye{
      width:18px;height:18px;
      border-radius:50%;
      background:#f9fafb;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 0 0 2px rgba(15,23,42,.55);
      overflow:hidden;
    }
    .fish-pupil{
      width:8px;height:8px;
      border-radius:50%;
      background:#0f172a;
      transition:transform .15s;
    }
    .fish-figure[data-dir="right"] .fish-pupil{
      transform:translateX(2px);
    }
    .fish-figure[data-dir="left"] .fish-pupil{
      transform:translateX(-2px);
    }

    .fish-body{
      position:absolute;
      left:50%;
      top:50%;
      width:82px;
      height:82px;
      transform:translate(-50%,-50%) rotate(45deg);
      background:#f9fafb;
      border-radius:10px;
      box-shadow:0 0 0 2px rgba(148,163,255,.8);
    }
    .fish-body-inner{
      position:absolute;
      inset:7px;
      border-radius:9px;
      background:linear-gradient(135deg,#e0f2fe,#bfdbfe);
      box-shadow:0 0 0 2px rgba(148,163,255,.5) inset;
    }
    .fish-dot{
      position:absolute;
      width:10px;height:10px;
      border-radius:50%;
      background:#22c55e;
      box-shadow:0 0 0 2px rgba(248,250,252,.9);
    }
    .fish-dot.tl{left:4px;top:4px;}
    .fish-dot.tr{right:4px;top:4px;}
    .fish-dot.bl{left:4px;bottom:4px;}
    .fish-dot.br{right:4px;bottom:4px;}

    .fish-cross{
      position:absolute;
      inset:10px;
      transform:rotate(-45deg);
      display:grid;
      grid-template-columns:1fr 1fr;
      grid-template-rows:1fr 1fr;
      align-items:center;
      justify-items:center;
      font-weight:700;
      color:#1f2937;
      font-size:.9rem;
    }
    .fish-num{
      min-width:20px;
      text-align:center;
    }
    .fish-cross-lines::before,
    .fish-cross-lines::after{
      content:'';
      position:absolute;
      background:#f59e0b;
    }
    .fish-cross-lines::before{
      width:2px;
      top:8px;bottom:8px;
      left:50%;
      transform:translateX(-50%);
    }
    .fish-cross-lines::after{
      height:2px;
      left:8px;right:8px;
      top:50%;
      transform:translateY(-50%);
    }

    /* PLANETS */
    .card-visual--planets_select{
      background:radial-gradient(circle at 20% -10%,#f97316 0,#0f172a 45%,#020617 100%);
    }
    .planet-row{
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .planet{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:900;
      font-size:1rem;
      color:#0b1120;
      box-shadow:0 0 22px rgba(15,23,42,.55);
    }
    .planet-1{
      width:86px;height:86px;border-radius:999px;
      background:radial-gradient(circle at 30% 10%,#fef9c3 0,#fde047 30%,#f97316 70%,#b91c1c 100%);
    }
    .planet-2{
      width:72px;height:72px;border-radius:40% 60% 55% 45%;
      background:radial-gradient(circle at 20% 0,#e0f2fe 0,#7dd3fc 30%,#0ea5e9 70%,#0369a1 100%);
    }
    .planet-3{
      width:96px;height:96px;border-radius:999px;
      background:radial-gradient(circle at 40% 0,#f5f3ff 0,#a855f7 40%,#6d28d9 80%);
    }
    .planet-4{
      width:80px;height:80px;border-radius:35% 65% 40% 60%;
      background:radial-gradient(circle at 10% 0,#fee2e2 0,#fb7185 40%,#be123c 85%);
    }
    .planet-5{
      width:70px;height:70px;border-radius:999px;
      background:radial-gradient(circle at 20% 10%,#dcfce7 0,#22c55e 35%,#15803d 85%);
    }
    .planet-ring{
      position:absolute;
      inset:-7px;
      border-radius:50%;
      border:2px solid rgba(15,23,42,.4);
      border-top-color:rgba(248,250,252,.7);
      opacity:.9;
      transform:rotate(-18deg);
      pointer-events:none;
    }
    .planet-core{
      position:relative;
      z-index:1;
    }
    .planet-hint{
      font-size:.78rem;
      margin-top:8px;
      opacity:.9;
    }

    /* CLOCK */
    .card-visual--clock_equal_sums{
      background:radial-gradient(circle at 20% -10%,#38bdf8 0,#020617 55%,#000 100%);
    }
    .clock{
      width:230px;height:230px;border-radius:50%;
      border:3px solid rgba(148,163,255,.9);
      margin:6px auto 0;
      position:relative;
      box-shadow:0 0 0 2px rgba(15,23,42,.9),0 0 40px rgba(56,189,248,.35);
      background:radial-gradient(circle,#020617 0,#020617 40%,#020617 100%);
    }
    .clock-center{
      position:absolute;left:50%;top:50%;
      width:12px;height:12px;border-radius:50%;
      background:#e5e7eb;
      transform:translate(-50%,-50%);
      box-shadow:0 0 10px rgba(148,163,255,.7);
    }
    .clock-number{
      position:absolute;
      width:24px;height:24px;border-radius:50%;
      display:flex;align-items:center;justify-content:center;
      font-size:.8rem;font-weight:700;
      background:rgba(15,23,42,.9);
      color:#e5edff;
      border:1px solid rgba(148,163,255,.7);
    }
    .clock-chord{
      position:absolute;
      width:2px;height:100%;
      left:50%;top:0;
      transform-origin:50% 50%;
      pointer-events:none;
    }
    .clock-chord::before{
      content:'';
      position:absolute;
      top:16%;
      bottom:16%;
      left:0;
      right:0;
      margin:auto;
      background:linear-gradient(to bottom,#f97316,#facc15);
      box-shadow:0 0 12px rgba(250,204,21,.7);
    }
    .clock-controls{
      margin-top:10px;
      display:flex;
      justify-content:center;
      align-items:center;
      gap:8px;
      font-size:.78rem;
    }
    .clock-btn{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,255,.8);
      background:rgba(15,23,42,.9);
      color:#e5edff;
      cursor:pointer;
      font-size:.78rem;
    }
    .clock-btn:active{
      transform:translateY(1px);
    }
    .clock-angle{
      opacity:.85;
    }

    /* WORD LADDER */
    .card-visual--word_ladder_lisa_nora{
      background:linear-gradient(135deg,#4f46e5,#0f172a);
    }
    .ladder{
      display:flex;
      flex-direction:column;
      gap:6px;
      position:relative;
      padding-left:10px;
      margin-top:4px;
    }
    .ladder::before{
      content:'';
      position:absolute;
      left:16px;
      top:4px;
      bottom:4px;
      width:2px;
      background:linear-gradient(to bottom,rgba(191,219,254,.2),rgba(96,165,250,.9));
    }
    .ladder-step{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .ladder-badge{
      width:24px;height:24px;border-radius:999px;
      background:#0ea5e9;
      display:flex;align-items:center;justify-content:center;
      font-size:.75rem;font-weight:800;
      box-shadow:0 0 10px rgba(59,130,246,.65);
      color:#0b1120;
    }
    .ladder-word{
      min-width:60px;
      padding:4px 10px;
      border-radius:999px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,255,.6);
      font-weight:700;
      letter-spacing:.08em;
      font-size:.85rem;
    }
    .ladder-input{
      width:80px;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,255,.8);
      background:#020617;
      color:#e5e7eb;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:.8rem;
      outline:none;
    }
    .ladder-input::placeholder{
      color:rgba(148,163,255,.6);
    }
    .ladder-input:focus{
      border-color:#c7d2fe;
      box-shadow:0 0 0 2px rgba(129,140,248,.6);
    }
    .ladder-hint{
      font-size:.8rem;
      opacity:.9;
      margin-top:6px;
    }

    /* ROBOT — вертикальная карточка как в референсе */
    .card-visual--robot_pair_to_target{
      background:radial-gradient(circle at -10% -10%,#22c55e 0,#0f172a 55%,#020617 100%);
    }
    .robot-layout{
      display:flex;
      flex-wrap:wrap;
      gap:18px;
      margin-top:4px;
      align-items:stretch;
    }
    .robot-illustration{
      flex:0 0 190px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .robot-text{
      flex:1 1 200px;
      font-size:.86rem;
      line-height:1.55;
    }
    @media (max-width:520px){
      .robot-illustration{
        flex:1 1 100%;
        order:1;
      }
      .robot-text{
        flex:1 1 100%;
        order:2;
        margin-top:4px;
      }
    }
    .robot-core{
      position:relative;
      width:160px;
      height:200px;
    }
    .robot-head{
      position:absolute;
      top:0;
      left:50%;
      width:96px;
      height:64px;
      transform:translateX(-50%);
      border-radius:22px;
      background:linear-gradient(135deg,#bbf7d0,#4ade80);
      box-shadow:0 10px 22px rgba(22,163,74,.7);
      border:2px solid #dcfce7;
    }
    .robot-eye{
      position:absolute;
      top:20px;
      width:18px;
      height:14px;
      border-radius:999px;
      background:#022c22;
      box-shadow:0 0 0 1px rgba(34,197,94,.7);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .robot-eye::before{
      content:'';
      width:8px;
      height:8px;
      border-radius:50%;
      background:#bbf7d0;
    }
    .robot-eye.left{left:16px;}
    .robot-eye.right{right:16px;}
    .robot-mouth{
      position:absolute;
      left:20px;
      right:20px;
      bottom:16px;
      height:7px;
      border-radius:999px;
      background:#022c22;
      box-shadow:0 0 0 1px rgba(34,197,94,.8);
    }

    .robot-body{
      position:absolute;
      top:70px;
      left:50%;
      width:120px;
      height:90px;
      transform:translateX(-50%);
      background:linear-gradient(135deg,#020617,#0b1120);
      border-radius:20px;
      box-shadow:0 12px 26px rgba(15,23,42,.9);
      border:2px solid rgba(148,163,255,.9);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      padding:6px 8px;
    }
    .robot-display{
      width:80px;
      height:40px;
      border-radius:10px;
      background:#020617;
      border:2px solid #22c55e;
      display:flex;
      align-items:center;
      justify-content:center;
      font-family:"SF Mono",ui-monospace,Menlo,Consolas,"Courier New",monospace;
      font-size:1.3rem;
      letter-spacing:.12em;
      color:#bbf7d0;
      box-shadow:0 0 18px rgba(34,197,94,.9);
    }
    .robot-display-label{
      margin-top:6px;
      font-size:.72rem;
      text-transform:uppercase;
      letter-spacing:.18em;
      color:#a5b4fc;
    }

    .robot-side{
      position:absolute;
      top:86px;
      width:44px;
      height:44px;
      border-radius:16px;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      box-shadow:0 8px 20px rgba(22,163,74,.8);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:800;
      color:#022c22;
      font-size:1.2rem;
      border:2px solid #bbf7d0;
    }
    .robot-side.left{left:0;}
    .robot-side.right{right:0;}

    .robot-wheel{
      position:absolute;
      bottom:0;
      width:40px;
      height:18px;
      border-radius:999px;
      background:#020617;
      box-shadow:0 6px 12px rgba(0,0,0,.9);
      border:2px solid #6b7280;
    }
    .robot-wheel.left{left:28px;}
    .robot-wheel.right{right:28px;}

    .robot-text-title{
      font-size:.86rem;
      font-weight:600;
      opacity:.92;
      margin-bottom:4px;
    }
    .robot-text-formula{
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Mono",ui-monospace,Menlo,Monaco,Consolas,"Courier New",monospace;
      font-size:.9rem;
      margin-bottom:6px;
    }
    .robot-text-desc{
      font-size:.86rem;
      margin-bottom:4px;
    }
    .robot-text-hint{
      font-size:.8rem;
      opacity:.9;
    }

    /* CUBE NETS — статичный куб с ракурсом */
    .card-visual--cube_nets_select{
      background:linear-gradient(135deg,#22c55e,#4f46e5,#0f172a);
    }
    .cube-wrapper{
      width:140px;
      height:140px;
      margin:0 auto 10px;
      perspective:900px;
    }
    .cube-demo{
      width:90px;
      height:90px;
      position:relative;
      margin:auto;
      transform-style:preserve-3d;
      transform:rotateX(-26deg) rotateY(-32deg);
    }
    .cube-face{
      position:absolute;
      width:90px;
      height:90px;
      border-radius:10px;
      background:#111827;
      border:2px solid rgba(191,219,254,.95);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#e5f0ff;
      font-size:1rem;
      text-shadow:0 0 8px rgba(15,23,42,.9);
      overflow:hidden;
      backface-visibility:hidden;
      box-shadow:0 10px 22px rgba(15,23,42,.8);
    }
    .cube-face::before{
      content:'';
      font-weight:800;
    }
    .cube-face.front{
      background:#a855f7;
      transform:translateZ(45px);
    }
    .cube-face.front::before{
      content:'я';
      font-size:2.6rem;
    }
    .cube-face.back{
      background:#0ea5e9;
      transform:rotateY(180deg) translateZ(45px);
    }
    .cube-face.back::before{
      content:'•';
      font-size:3rem;
    }
    .cube-face.right{
      background:repeating-linear-gradient(
        90deg,
        #f97316 0,#f97316 10px,
        #ecfeff 10px,#ecfeff 14px,
        #7c2d12 14px,#7c2d12 24px
      );
      transform:rotateY(90deg) translateZ(45px);
    }
    .cube-face.right::before{
      content:'';
      font-size:0;
    }
    .cube-face.left{
      background:#22c55e;
      transform:rotateY(-90deg) translateZ(45px);
    }
    .cube-face.left::before{
      content:'+';
      font-size:2.4rem;
    }
    .cube-face.top{
      background:#facc15;
      transform:rotateX(90deg) translateZ(45px);
      color:#92400e;
    }
    .cube-face.top::before{
      content:'×';
      font-size:2.2rem;
    }
    .cube-face.bottom{
      background:#111827;
      transform:rotateX(-90deg) translateZ(45px);
    }
    .cube-face.bottom::before{
      content:'○';
      font-size:2.4rem;
    }

    .nets-row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      margin-top:4px;
    }
    .net{
      flex:1 1 130px;
      min-width:130px;
      border-radius:14px;
      padding:6px 8px 10px;
      background:rgba(15,23,42,.86);
      border:1px solid rgba(209,250,229,.7);
      position:relative;
      font-size:.8rem;
    }
    .net-label{
      position:absolute;
      top:5px;right:6px;
      font-weight:800;
      color:#bbf7d0;
    }
    .net-grid{
      display:grid;
      grid-template-columns:repeat(4,22px);
      grid-auto-rows:22px;
      gap:4px;
      margin-top:14px;
      justify-content:center;
    }
    .net-cell{
      border-radius:4px;
      border:1px solid transparent;
      background:transparent;
      position:relative;
    }
    .net-cell.filled{
      background:#0b1120;
      border-color:rgba(148,163,255,.85);
      box-shadow:0 0 0 1px rgba(15,23,42,.9);
    }
    .net-cell.center{
      box-shadow:0 0 0 2px #fbbf24,0 0 10px rgba(250,204,21,.7);
    }
    .net-icon{
      position:absolute;
      inset:2px;
      border-radius:3px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:.75rem;
      font-weight:800;
      color:#0b1120;
    }
    .net-icon--letter{
      background:#a855f7;
      color:#f9fafb;
      font-size:.9rem;
    }
    .net-icon--x{
      background:#22c55e;
      color:#065f46;
      font-size:.85rem;
    }
    .net-icon--plus{
      background:#facc15;
      color:#92400e;
      font-size:.9rem;
    }
    .net-icon--dot{
      background:#1d4ed8;
      color:#e5e7eb;
      font-size:1.2rem;
    }
    .net-icon--stripes{
      background:repeating-linear-gradient(
        135deg,
        #f97316 0,#f97316 6px,
        #ecfeff 6px,#ecfeff 10px,
        #7c2d12 10px,#7c2d12 16px
      );
      color:transparent;
    }

    /* GRAPHS */
    .card-visual--graph_match_trend{
      background:radial-gradient(circle at -10% -10%,#22d3ee 0,#0f172a 50%,#000 100%);
    }
    .graphs-row{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:4px;
    }
    .graph-card{
      width:100%;
      border-radius:14px;
      padding:6px 8px 10px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,255,.8);
      font-size:.8rem;
    }
    .graph-label{
      font-weight:700;
      margin-bottom:4px;
      color:#bfdbfe;
    }
    .graph-canvas{
      position:relative;
      height:110px;
      border-radius:10px;
      background:radial-gradient(circle at 0 0,rgba(56,189,248,.28),rgba(15,23,42,1));
      overflow:hidden;
      padding:6px 8px 8px;
    }
    .graph-svg{
      width:100%;
      height:100%;
      display:block;
    }
    .graph-axis{
      stroke:rgba(148,163,255,.8);
      stroke-width:1;
    }
    .graph-grid{
      stroke:rgba(148,163,255,.3);
      stroke-width:0.5;
      stroke-dasharray:3 3;
    }
    .graph-path-a{
      fill:none;
      stroke:#22c55e;
      stroke-width:2.4;
      stroke-linecap:round;
      stroke-linejoin:round;
    }
    .graph-path-b{
      fill:none;
      stroke:#f97316;
      stroke-width:2.4;
      stroke-linecap:round;
      stroke-linejoin:round;
    }

    /* ROUTE */
    .card-visual--route_min_steps{
      background:radial-gradient(circle at 10% -10%,#22c55e 0,#0f172a 55%,#000 100%);
      min-height:320px;
    }
    .grid{
      display:grid;
      grid-template-columns:repeat(7,20px);
      grid-auto-rows:20px;
      gap:4px;
      margin-top:10px;
      justify-content:center;
    }
    .cell{
      border-radius:5px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(34,197,94,.5);
    }
    .cell.block{
      background:rgba(127,29,29,.9);
      border-color:rgba(248,113,113,.8);
    }
    .cell.start{
      background:rgba(59,130,246,.95);
      border-color:#bfdbfe;
    }
    .cell.finish{
      background:rgba(234,179,8,.95);
      border-color:#facc15;
    }
    .route-legend{
      margin-top:8px;
      font-size:.78rem;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .route-legend-item{
      display:flex;
      align-items:center;
      gap:4px;
    }
    .route-dot{
      width:12px;height:12px;border-radius:4px;
      border:1px solid rgba(148,163,255,.6);
    }
    .route-dot.start{
      background:rgba(59,130,246,.95);
      border-color:#bfdbfe;
    }
    .route-dot.finish{
      background:rgba(234,179,8,.95);
      border-color:#facc15;
    }
    .route-dot.block{
      background:rgba(127,29,29,.9);
      border-color:rgba(248,113,113,.8);
    }

    /* SHAPES EQUATION (новая карточка по референсу с фруктами) */
    .card-visual--shapes_equation{
      background:radial-gradient(circle at -10% -10%,#f97316 0,#b91c1c 40%,#0f172a 100%);
      min-height:260px;
    }
    .shapes-eq{
      margin-top:8px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .shapes-eq-row{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      flex-wrap:nowrap;
    }
    .shapes-eq-row .eq-symbol{
      font-size:1.4rem;
      font-weight:800;
      padding:0 4px;
    }
    .shapes-eq-row .eq-number{
      min-width:32px;
      text-align:left;
      font-size:1.4rem;
      font-weight:800;
    }
    .shape-icon{
      position:relative;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .shape-square-big{
      width:60px;
      height:60px;
      border-radius:16px;
      background:linear-gradient(135deg,#fee2e2,#fecaca);
      box-shadow:0 8px 18px rgba(127,29,29,.8);
      border:3px solid rgba(254,202,202,1);
    }
    .shape-square-big::before{
      content:'';
      position:absolute;
      inset:10px;
      border-radius:12px;
      background:radial-gradient(circle at 20% 10%,#fef2f2 0,#f97316 55%,#b91c1c 100%);
    }
    .shape-tri-stack{
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:4px;
    }
    .shape-tri{
      width:0;
      height:0;
      border-left:18px solid transparent;
      border-right:18px solid transparent;
      border-bottom:30px solid #facc15;
      filter:drop-shadow(0 6px 10px rgba(180,83,9,.9));
    }
    .shape-tri.shape-tri-small{
      border-left-width:14px;
      border-right-width:14px;
      border-bottom-width:24px;
    }
    .shape-hex-pair{
      display:flex;
      gap:4px;
      align-items:center;
    }
    .shape-hex{
      width:34px;
      height:34px;
      position:relative;
    }
    .shape-hex::before{
      content:'';
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 30% 10%,#e5f0ff 0,#93c5fd 35%,#1d4ed8 90%);
      clip-path:polygon(
        25% 0,
        75% 0,
        100% 50%,
        75% 100%,
        25% 100%,
        0 50%
      );
      box-shadow:0 6px 14px rgba(15,23,42,.9);
    }
    .shape-hex-half{
      width:38px;
      height:38px;
      position:relative;
    }
    .shape-hex-half::before{
      content:'';
      position:absolute;
      inset:0;
      background:radial-gradient(circle at 20% 0,#e5f0ff 0,#93c5fd 35%,#1d4ed8 90%);
      clip-path:polygon(
        25% 0,
        75% 0,
        100% 50%,
        75% 100%,
        25% 100%,
        0 50%
      );
      box-shadow:0 6px 14px rgba(15,23,42,.9);
    }
    .shapes-caption{
      margin-top:6px;
      font-size:.8rem;
      opacity:.9;
    }

    /* PATTERN MATRIX */
    .card-visual--pattern_matrix{
      background:radial-gradient(circle at 10% -10%,#6366f1 0,#0f172a 45%,#020617 100%);
    }
    .matrix{
      display:grid;
      grid-template-columns:repeat(3,50px);
      grid-auto-rows:50px;
      gap:8px;
      margin-top:12px;
      justify-content:center;
    }
    .matrix-cell{
      border-radius:10px;
      border:1px solid rgba(191,219,254,.8);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:1rem;
      font-weight:700;
      background:rgba(15,23,42,.92);
    }
    .matrix-cell.question{
      border-style:dashed;
      color:#fbbf24;
      text-shadow:0 0 12px rgba(250,204,21,.9);
    }

    /* HISTORY TABLE */
    .history-table-wrapper{
      margin-top:8px;
      overflow-x:auto;
    }
    .history-table{
      width:100%;
      border-collapse:collapse;
      font-size:.86rem;
    }
    .history-table th,
    .history-table td{
      padding:6px 8px;
      border-bottom:1px solid #e5e7f2;
      text-align:left;
      vertical-align:top;
    }
    .history-table th{
      font-weight:600;
      color:var(--muted);
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .history-table tr:last-child td{
      border-bottom:none;
    }
    .history-table td.status-ok{
      color:var(--ok);
      font-weight:600;
    }
    .history-table td.status-bad{
      color:var(--bad);
      font-weight:600;
    }

    /* TOAST */
    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      padding:11px 14px;
      background:#0f172a;
      color:#e5e7eb;
      border-radius:12px;
      opacity:.98;
      box-shadow:0 10px 26px rgba(15,23,42,.6);
      font-size:.9rem;
      max-width:90%;
      z-index:20;
    }
  </style>
</head>
<body>
  <div class="toast" id="toast" style="display:none"></div>

  <!-- JOIN -->
  <div class="screen active" id="join">
    <div class="card">
      <div class="top">
        <div>
          <div class="brand-mark">
            <div class="brand-logo"></div>
            <div>
              <h1>СОНП</h1>
              <div class="muted">Система оценки научного потенциала</div>
            </div>
          </div>
        </div>
        <div class="pill">Участник</div>
      </div>
    </div>
    <div class="card">
      <label>Код комнаты</label>
      <input id="room" type="text" maxlength="4" placeholder="Например: AB3D"/>
      <label>Ваш ник</label>
      <input id="name" type="text" maxlength="32" placeholder="Иван"/>
      <div style="height:12px"></div>
      <button class="btn" id="btnJoin">Войти в сессию</button>
    </div>
  </div>

  <!-- LOBBY -->
  <div class="screen" id="lobby">
    <div class="card top">
      <div><b>Комната:</b> <span id="roomShow">----</span></div>
      <div class="pill" id="count">0/10</div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px">Игроки</h3>
      <ul id="players" class="muted" style="margin:0;"></ul>
      <div class="muted" style="margin-top:8px;font-size:.9rem">
        Ожидаем, пока администратор запустит сессию…
      </div>
    </div>
  </div>

  <!-- QUESTION -->
  <div class="screen" id="question">
    <div class="card top">
      <div><b>Раунд</b> <span id="rnum">1</span>/<span id="rtotal">6</span></div>
      <div class="pill timer" id="timer">0:45</div>
    </div>
    <div class="card">
      <div class="muted" id="cat">Категория</div>

      <!-- ВИЗУАЛЬНАЯ КАРТОЧКА -->
      <div id="cardVisual" class="card-visual" style="display:none"></div>

      <h3 id="qtext" style="margin-top:6px"></h3>

      <!-- Варианты для mcq -->
      <div id="mcq" class="answers" style="display:none"></div>

      <!-- Поле ввода для текстового ответа (для обычных задач, не карточек) -->
      <div id="textBox" style="display:none;margin-top:10px">
        <input id="answerText" type="text" placeholder="Ваш ответ" />
        <div style="height:10px"></div>
        <button class="btn" id="btnSendText">Отправить ответ</button>
      </div>
    </div>
  </div>

  <!-- REVEAL -->
  <div class="screen" id="reveal">
    <div class="card top">
      <div><b>Раунд</b> <span id="rnum2">1</span></div>
      <div class="pill" id="cat2">Категория</div>
    </div>
    <div class="card">
      <div class="muted">Задание</div>
      <h3 id="qtext2" style="margin-top:6px"></h3>
      <div id="correct" class="muted" style="margin-top:8px;font-size:.9rem"></div>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px">Ваши и чужие ответы</h3>
      <ul id="results" style="margin:0;padding-left:18px"></ul>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px">Текущие очки</h3>
      <ul id="scores" style="margin:0;padding-left:18px"></ul>
    </div>
  </div>

  <!-- FINAL -->
  <div class="screen" id="final">
    <div class="card">
      <h2>Сессия завершена</h2>
      <div class="muted">Итоговые очки участников</div>
    </div>
    <div class="card">
      <ul id="fscores" style="margin:0;padding-left:18px"></ul>
    </div>
    <div class="card">
      <h3 style="margin:0 0 8px">Мои ответы</h3>
      <div class="muted" style="font-size:.9rem;margin-bottom:4px">
        Таблица с вашей полной историей решений по раундам.
      </div>
      <div class="history-table-wrapper">
        <table class="history-table">
          <thead>
            <tr>
              <th>Раунд</th>
              <th>Категория</th>
              <th>Кратко о задании</th>
              <th>Мой ответ</th>
              <th>Верно</th>
              <th>Баллы</th>
              <th>Время</th>
            </tr>
          </thead>
          <tbody id="myHistoryBody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
  const $ = (id)=>document.getElementById(id);
  const host = location.host || '127.0.0.1:8000';
  let ws = null, playerId=null, roomCode=null, timerId=null, deadline=0, myHistory=[];

  const toastEl = $('toast');
  function toast(msg){
    toastEl.textContent = msg;
    toastEl.style.display = 'block';
    setTimeout(()=>{ toastEl.style.display='none'; }, 1700);
  }
  function fmt(sec){
    sec = Math.max(0, sec|0);
    return String(Math.floor(sec/60)) + ':' + String(sec%60).padStart(2,'0');
  }
  function show(id){
    document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
    $(id).classList.add('active');
  }
  function tick(){
    const left = Math.max(0, Math.floor(deadline - Date.now()/1000));
    $('timer').textContent = fmt(left);
    if (left<=0) clearInterval(timerId);
  }


  $('room').addEventListener('input', e=>{
    e.target.value = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,4);
  });

  function sendTextAnswer(text){
    if (!text){
      toast('Введите ответ');
      return;
    }
    if (!ws || !roomCode || !playerId) return;
    ws.send(JSON.stringify({ type:'answer', roomCode, playerId, text }));
    toast('Ответ отправлен');
  }

  $('btnJoin').onclick = ()=>{
    const code = $('room').value.trim().toUpperCase();
    const name = $('name').value.trim();
    if (code.length!==4){ toast('Код комнаты — 4 символа'); return; }
    if (!name){ toast('Введите ник'); return; }

    roomCode = code;
    myHistory = [];
    ws = new WebSocket('ws://' + host + '/ws');
    ws.onopen = ()=>{
      ws.send(JSON.stringify({ type:'join', roomCode: code, playerName: name }));
    };
    ws.onmessage = onMessage;
    ws.onerror = ()=> toast('Ошибка соединения');
  };

  $('btnSendText').onclick = ()=>{
    const text = $('answerText').value.trim();
    sendTextAnswer(text);
    $('btnSendText').disabled = true;
  };

  function onMessage(e){
    const m = JSON.parse(e.data);
    if (m.type === 'error'){
      toast(m.message || 'Ошибка');
      return;
    }

    if (m.type === 'joined'){
      playerId = m.playerId;
      $('roomShow').textContent = m.roomCode;
      renderPlayers(m.players || []);
      $('count').textContent = String((m.players||[]).length) + '/10';
      show('lobby');
      return;
    }

    if (m.type === 'players'){
      renderPlayers(m.players || []);
      $('count').textContent = String((m.players||[]).length) + '/10';
      return;
    }

    if (m.type === 'game_started'){
      toast('Сессия началась');
      return;
    }

    if (m.type === 'question'){
      handleQuestion(m);
      return;
    }

    if (m.type === 'reveal'){
      handleReveal(m);
      return;
    }

    if (m.type === 'final'){
      handleFinal(m);
      return;
    }
  }

  function renderPlayers(players){
    const ul = $('players');
    ul.innerHTML = '';
    (players || []).forEach(p=>{
      const li = document.createElement('li');
      li.textContent = p.name + ' — ' + (p.score || 0);
      ul.appendChild(li);
    });
  }

  function clearCardVisual(){
    const cv = $('cardVisual');
    cv.innerHTML = '';
    cv.style.display = 'none';
    cv.className = 'card-visual';
  }

  function handleQuestion(m){
    $('rnum').textContent = m.round;
    $('rtotal').textContent = m.totalRounds;
    $('cat').textContent = m.category;
    $('qtext').textContent = m.prompt;

    const tl = m.timeLimit || 45;
    deadline = Date.now()/1000 + tl;
    clearInterval(timerId);
    timerId = setInterval(tick, 250);
    tick();

    if (m.mode === 'card'){
      renderCardVisual(m);
    }else{
      clearCardVisual();
    }

    if (m.qtype === 'mcq'){
      $('mcq').style.display = '';
      $('textBox').style.display = 'none';
      renderOptions(m);
    }else{
      $('mcq').style.display = 'none';
      if (m.mode === 'card'){
        $('textBox').style.display = 'none';
      }else{
        $('textBox').style.display = '';
        $('answerText').value = '';
        $('btnSendText').disabled = false;
        $('answerText').focus();
      }
    }

    show('question');
  }

  function renderOptions(m){
    const root = $('mcq');
    root.innerHTML = '';
    const opts = m.options || [];
    opts.forEach((opt, idx)=>{
      const btn = document.createElement('button');
      btn.className = 'opt';
      const labelChar = String.fromCharCode(0x0410 + idx);
      btn.innerHTML = '<span class="label">' + labelChar + '</span>' + escapeHtml(opt);
      btn.onclick = ()=>{
        document.querySelectorAll('.opt').forEach(x=>x.classList.remove('selected'));
        btn.classList.add('selected');
        if (!ws || !roomCode || !playerId) return;
        ws.send(JSON.stringify({ type:'answer', roomCode, playerId, choice: idx }));
      };
      root.appendChild(btn);
    });
  }

  function renderCardVisual(m){
    const cv = $('cardVisual');
    clearCardVisual();
    cv.style.display = 'block';
    cv.classList.add('card-visual--' + (m.subtype || 'generic'));

    const header = document.createElement('div');
    header.className = 'card-visual-header';
    header.textContent = 'Когнитивная карточка';
    cv.appendChild(header);

    const title = document.createElement('div');
    title.className = 'card-visual-title';
    switch (m.subtype){
      case 'fish_odd_one_out':
        title.textContent = 'Найдите лишнюю рыбку по числовой закономерности';
        break;
      case 'planets_select':
        title.textContent = 'Определите, какие планеты относятся к выбранному критерию';
        break;
      case 'clock_equal_sums':
        title.textContent = 'Разделите циферблат на две части с равной суммой чисел';
        break;
      case 'word_ladder_lisa_nora':
        title.textContent = 'Постройте лестницу слов от ЛИСА до НОРА';
        break;
      case 'robot_pair_to_target':
        title.textContent = 'Подберите числа для робота-калькулятора';
        break;
      case 'cube_nets_select':
        title.textContent = 'Выберите развёртки куба, соответствующие образцу';
        break;
      case 'graph_match_trend':
        title.textContent = 'Сопоставьте ситуацию с подходящим графиком';
        break;
      case 'route_min_steps':
        title.textContent = 'Найдите кратчайший маршрут по сетке';
        break;
      case 'shapes_equation':
        title.textContent = 'Сделайте вывод о значениях фигур и вычислите последнее выражение';
        break;
      case 'pattern_matrix':
        title.textContent = 'Определите недостающее значение в матрице';
        break;
      default:
        title.textContent = 'Когнитивная задача';
    }
    cv.appendChild(title);

    let ladderInputs = null;

    switch (m.subtype){
      case 'fish_odd_one_out':
        renderFishCard(cv, m);
        break;
      case 'planets_select':
        renderPlanetsCard(cv);
        break;
      case 'clock_equal_sums':
        renderClockCard(cv);
        break;
      case 'word_ladder_lisa_nora':
        ladderInputs = renderLadderCard(cv);
        break;
      case 'robot_pair_to_target':
        renderRobotCard(cv);
        break;
      case 'cube_nets_select':
        renderCubeNetsCard(cv);
        break;
      case 'graph_match_trend':
        renderGraphsCard(cv);
        break;
      case 'route_min_steps':
        renderRouteCard(cv);
        break;
      case 'shapes_equation':
        renderShapesEquationCard(cv);
        break;
      case 'pattern_matrix':
        renderMatrixCard(cv);
        break;
      default:
        const generic = document.createElement('div');
        generic.className = 'muted';
        generic.style.fontSize = '.82rem';
        generic.textContent = 'Ответ вводите по правилам, указанным в тексте задания.';
        cv.appendChild(generic);
    }

    if (m.qtype === 'text'){
      if (m.subtype === 'word_ladder_lisa_nora'){
        const wrap = document.createElement('div');
        wrap.className = 'card-input';

        const info = document.createElement('div');
        info.className = 'muted';
        info.style.fontSize = '.8rem';
        info.textContent = 'Заполните все промежуточные слова в лестнице (каждый шаг — новое слово), затем отправьте ответ.';
        wrap.appendChild(info);

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn';
        btn.textContent = 'Отправить ответ';
        btn.onclick = ()=>{
          if (!ladderInputs || ladderInputs.length === 0){
            toast('Нет полей для ввода');
            return;
          }
          const startWord = 'ЛИСА';
          const endWord = 'НОРА';
          const words = [startWord];
          let firstEmpty = null;

          ladderInputs.forEach(inp=>{
            const v = (inp.value || '').trim();
            if (!v && firstEmpty === null) firstEmpty = inp;
            words.push(v);
          });

          words.push(endWord);

          if (firstEmpty){
            toast('Заполните все шаги лестницы');
            firstEmpty.focus();
            return;
          }

          const chain = words.join(' -> ');
          sendTextAnswer(chain);
          btn.disabled = true;
        };
        wrap.appendChild(btn);

        cv.appendChild(wrap);
      }else{
        const wrap = document.createElement('div');
        wrap.className = 'card-input';

        const ta = document.createElement('textarea');
        ta.id = 'cardAnswer';
        ta.placeholder = 'Опишите решение или впишите ответ в соответствии с карточкой...';
        wrap.appendChild(ta);

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn';
        btn.textContent = 'Отправить ответ';
        btn.onclick = ()=>{
          const text = ta.value.trim();
          sendTextAnswer(text);
          btn.disabled = true;
        };
        wrap.appendChild(btn);

        cv.appendChild(wrap);
        setTimeout(()=>ta.focus(), 50);
      }
    }
  }

  /* РЫБКИ */
  function renderFishCard(cv, m){
    const list = document.createElement('div');
    list.className = 'fish-list';
    const opts = m.options || [];

    opts.forEach((opt, idx)=>{
      const row = document.createElement('div');
      row.className = 'fish-row ' + (idx % 2 === 0 ? 'fish-row--left' : 'fish-row--right');

      const label = document.createElement('div');
      label.className = 'fish-label';
      const letter = String.fromCharCode('A'.charCodeAt(0) + idx);
      label.textContent = 'Рыбка ' + letter;

      const arrow = document.createElement('div');
      arrow.className = 'fish-arrow';

      const fishFigure = document.createElement('div');
      fishFigure.className = 'fish-figure ' + (idx % 2 === 0 ? 'fish-figure--left' : 'fish-figure--right');
      fishFigure.dataset.dir = idx % 2 === 0 ? 'right' : 'left';

      const head = document.createElement('div');
      head.className = 'fish-head';
      const eye = document.createElement('div');
      eye.className = 'fish-eye';
      const pupil = document.createElement('div');
      pupil.className = 'fish-pupil';
      eye.appendChild(pupil);
      head.appendChild(eye);
      fishFigure.appendChild(head);

      const body = document.createElement('div');
      body.className = 'fish-body';
      const inner = document.createElement('div');
      inner.className = 'fish-body-inner';
      body.appendChild(inner);

      const dotTL = document.createElement('div'); dotTL.className = 'fish-dot tl';
      const dotTR = document.createElement('div'); dotTR.className = 'fish-dot tr';
      const dotBL = document.createElement('div'); dotBL.className = 'fish-dot bl';
      const dotBR = document.createElement('div'); dotBR.className = 'fish-dot br';
      body.appendChild(dotTL); body.appendChild(dotTR); body.appendChild(dotBL); body.appendChild(dotBR);

      const crossLines = document.createElement('div');
      crossLines.className = 'fish-cross-lines';
      body.appendChild(crossLines);

      const cross = document.createElement('div');
      cross.className = 'fish-cross';

      let tl = '?';
      let tr = '?';
      let bl = '?';
      let br = '?';

      const match = opt.match(/(\d+)\D+(\d+)\D+(\d+)\D+(\d+)/);
      if (match){
        tl = match[1];
        tr = match[2];
        bl = match[3];
        br = match[4];
      }else{
        const arr = opt.split(/[^0-9]+/).filter(Boolean);
        tl = arr[0] || '?';
        tr = arr[1] || '?';
        bl = arr[2] || '?';
        br = arr[3] || '?';
      }

      const tlEl = document.createElement('div'); tlEl.className = 'fish-num tl'; tlEl.textContent = tl;
      const trEl = document.createElement('div'); trEl.className = 'fish-num tr'; trEl.textContent = tr;
      const blEl = document.createElement('div'); blEl.className = 'fish-num bl'; blEl.textContent = bl;
      const brEl = document.createElement('div'); brEl.className = 'fish-num br'; brEl.textContent = br;

      cross.appendChild(tlEl);
      cross.appendChild(trEl);
      cross.appendChild(blEl);
      cross.appendChild(brEl);

      body.appendChild(cross);
      fishFigure.appendChild(body);

      if (idx % 2 === 0){
        row.appendChild(label);
        row.appendChild(fishFigure);
        row.appendChild(arrow);
      }else{
        row.appendChild(arrow);
        row.appendChild(fishFigure);
        row.appendChild(label);
      }

      list.appendChild(row);
    });
    cv.appendChild(list);
  }

  function renderPlanetsCard(cv){
    const row = document.createElement('div');
    row.className = 'planet-row';

    const config = [
      {num:9, cls:'planet planet-1'},
      {num:10, cls:'planet planet-2'},
      {num:25, cls:'planet planet-3'},
      {num:21, cls:'planet planet-4'},
      {num:11, cls:'planet planet-5'}
    ];

    config.forEach(cfg=>{
      const p = document.createElement('div');
      p.className = cfg.cls;
      const ring = document.createElement('div');
      ring.className = 'planet-ring';
      p.appendChild(ring);
      const inner = document.createElement('div');
      inner.className = 'planet-core';
      inner.textContent = String(cfg.num);
      p.appendChild(inner);
      row.appendChild(p);
    });
    cv.appendChild(row);

    const hint = document.createElement('div');
    hint.className = 'muted planet-hint';
    hint.textContent = 'Нумерация планет для ответа — слева направо: 1, 2, 3, 4, 5.';
    cv.appendChild(hint);
  }

  function renderClockCard(cv){
    const clock = document.createElement('div');
    clock.className = 'clock';

    for(let i=1;i<=12;i++){
      const angle = (i-3) * 30 * Math.PI/180;
      const r = 90;
      const x = 115 + r*Math.cos(angle);
      const y = 115 + r*Math.sin(angle);
      const n = document.createElement('div');
      n.className = 'clock-number';
      n.style.left = String(x-12) + 'px';
      n.style.top = String(y-12) + 'px';
      n.textContent = String(i);
      clock.appendChild(n);
    }

    const chord = document.createElement('div');
    chord.className = 'clock-chord';
    clock.appendChild(chord);

    const center = document.createElement('div');
    center.className = 'clock-center';
    clock.appendChild(center);

    cv.appendChild(clock);

    let angleIndex = 0;
    const angleSpan = document.createElement('span');

    function updateChord(){
      const deg = angleIndex * 30 + 15;
      chord.style.transform = 'rotate(' + deg + 'deg)';
      angleSpan.textContent = 'Поворот: ' + String(deg) + '°';
    }

    const controls = document.createElement('div');
    controls.className = 'clock-controls';

    const btnLeft = document.createElement('button');
    btnLeft.type = 'button';
    btnLeft.className = 'clock-btn';
    btnLeft.textContent = 'Повернуть влево';

    const btnRight = document.createElement('button');
    btnRight.type = 'button';
    btnRight.className = 'clock-btn';
    btnRight.textContent = 'Повернуть вправо';

    angleSpan.className = 'clock-angle';
    angleSpan.textContent = 'Поворот: 15°';

    btnLeft.onclick = ()=>{
      angleIndex = (angleIndex + 11) % 12;
      updateChord();
    };
    btnRight.onclick = ()=>{
      angleIndex = (angleIndex + 1) % 12;
      updateChord();
    };

    controls.appendChild(btnLeft);
    controls.appendChild(btnRight);
    controls.appendChild(angleSpan);
    cv.appendChild(controls);

    updateChord();
  }

  function renderLadderCard(cv){
    const ladder = document.createElement('div');
    ladder.className = 'ladder';
    const steps = ['ЛИСА','****','****','****','****','****','НОРА'];
    const inputs = [];

    steps.forEach((w, idx)=>{
      const row = document.createElement('div');
      row.className = 'ladder-step';

      const badge = document.createElement('div');
      badge.className = 'ladder-badge';
      badge.textContent = String(idx+1);

      row.appendChild(badge);

      if (idx === 0 || idx === steps.length - 1){
        const word = document.createElement('div');
        word.className = 'ladder-word';
        word.textContent = w;
        row.appendChild(word);
      }else{
        const inp = document.createElement('input');
        inp.type = 'text';
        inp.maxLength = 4;
        inp.placeholder = '....';
        inp.className = 'ladder-input';
        inp.addEventListener('input', e=>{
          e.target.value = e.target.value.toUpperCase().replace(/[^А-ЯЁA-Z]/g,'');
        });
        inputs.push(inp);
        row.appendChild(inp);
      }

      ladder.appendChild(row);
    });

    const hint = document.createElement('div');
    hint.className = 'ladder-hint';
    hint.textContent = 'На каждом шаге меняйте ровно одну букву и используйте только существующие слова.';
    ladder.appendChild(hint);
    cv.appendChild(ladder);

    return inputs;
  }

  function renderRobotCard(cv){
    const layout = document.createElement('div');
    layout.className = 'robot-layout';

    const illustration = document.createElement('div');
    illustration.className = 'robot-illustration';

    const core = document.createElement('div');
    core.className = 'robot-core';

    const head = document.createElement('div');
    head.className = 'robot-head';

    const eyeLeft = document.createElement('div');
    eyeLeft.className = 'robot-eye left';
    const eyeRight = document.createElement('div');
    eyeRight.className = 'robot-eye right';
    const mouth = document.createElement('div');
    mouth.className = 'robot-mouth';

    head.appendChild(eyeLeft);
    head.appendChild(eyeRight);
    head.appendChild(mouth);

    const body = document.createElement('div');
    body.className = 'robot-body';

    const display = document.createElement('div');
    display.className = 'robot-display';
    display.textContent = '72';

    const displayLabel = document.createElement('div');
    displayLabel.className = 'robot-display-label';
    displayLabel.textContent = 'результат';

    body.appendChild(display);
    body.appendChild(displayLabel);

    const sideLeft = document.createElement('div');
    sideLeft.className = 'robot-side left';
    sideLeft.textContent = 'a×b';

    const sideRight = document.createElement('div');
    sideRight.className = 'robot-side right';
    sideRight.textContent = '-5';

    const wheelLeft = document.createElement('div');
    wheelLeft.className = 'robot-wheel left';
    const wheelRight = document.createElement('div');
    wheelRight.className = 'robot-wheel right';

    core.appendChild(head);
    core.appendChild(body);
    core.appendChild(sideLeft);
    core.appendChild(sideRight);
    core.appendChild(wheelLeft);
    core.appendChild(wheelRight);

    illustration.appendChild(core);
    layout.appendChild(illustration);

    const text = document.createElement('div');
    text.className = 'robot-text';

    const tTitle = document.createElement('div');
    tTitle.className = 'robot-text-title';
    tTitle.textContent = 'Робот-калькулятор сначала перемножает числа, а затем вычитает 5.';

    const tFormula = document.createElement('div');
    tFormula.className = 'robot-text-formula';
    tFormula.textContent = 'f(a, b) = a · b - 5';

    const tDesc = document.createElement('div');
    tDesc.className = 'robot-text-desc';
    tDesc.textContent = 'Подберите любые целые положительные числа a и b такие, что результат вычисления функции равен 72.';

    const tHint = document.createElement('div');
    tHint.className = 'robot-text-hint';
    tHint.textContent = 'Ответ запишите в формате a,b.';

    text.appendChild(tTitle);
    text.appendChild(tFormula);
    text.appendChild(tDesc);
    text.appendChild(tHint);

    layout.appendChild(text);
    cv.appendChild(layout);
  }

  /* Развёртки куба */
  function renderCubeNetsCard(cv){
    const wrapper = document.createElement('div');
    wrapper.className = 'cube-wrapper';

    const cube = document.createElement('div');
    cube.className = 'cube-demo';

    const front = document.createElement('div');
    front.className = 'cube-face front';

    const back = document.createElement('div');
    back.className = 'cube-face back';

    const right = document.createElement('div');
    right.className = 'cube-face right';

    const left = document.createElement('div');
    left.className = 'cube-face left';

    const top = document.createElement('div');
    top.className = 'cube-face top';

    const bottom = document.createElement('div');
    bottom.className = 'cube-face bottom';

    cube.appendChild(front);
    cube.appendChild(back);
    cube.appendChild(right);
    cube.appendChild(left);
    cube.appendChild(top);
    cube.appendChild(bottom);

    wrapper.appendChild(cube);
    cv.appendChild(wrapper);

    const row = document.createElement('div');
    row.className = 'nets-row';

    const layouts = [
      {
        label:'А',
        pattern:[
          '0','X','0','0',
          '0','S','0','0',
          '0','L','O','+',
          '0','X','0','0'
        ]
      },
      {
        label:'Б',
        pattern:[
          '0','S','0','0',
          'X','L','O','0',
          '0','+','0','0',
          '0','X','0','0'
        ]
      },
      {
        label:'В',
        pattern:[
          '0','X','0','0',
          '0','L','O','0',
          '0','S','0','0',
          '+','X','0','0'
        ]
      },
      {
        label:'Г',
        pattern:[
          '0','X','0','0',
          '0','L','O','0',
          '0','+','0','0',
          '0','S','X','0'
        ]
      },
      {
        label:'Д',
        pattern:[
          'X','S','0','0',
          '0','L','O','+',
          '0','X','0','0',
          '0','0','0','0'
        ]
      }
    ];

    layouts.forEach(layout=>{
      const net = document.createElement('div');
      net.className = 'net';

      const lbl = document.createElement('div');
      lbl.className = 'net-label';
      lbl.textContent = layout.label;
      net.appendChild(lbl);

      const grid = document.createElement('div');
      grid.className = 'net-grid';

      layout.pattern.forEach(t=>{
        const cell = document.createElement('div');
        cell.className = 'net-cell';
        if (t !== '0'){
          cell.classList.add('filled');
          const icon = document.createElement('div');
          icon.className = 'net-icon';

          if (t === 'L'){
            cell.classList.add('center');
            icon.classList.add('net-icon--letter');
            icon.textContent = 'я';
          }else if (t === 'X'){
            icon.classList.add('net-icon--x');
            icon.textContent = '×';
          }else if (t === '+'){
            icon.classList.add('net-icon--plus');
            icon.textContent = '+';
          }else if (t === 'O'){
            icon.classList.add('net-icon--dot');
            icon.textContent = '•';
          }else if (t === 'S'){
            icon.classList.add('net-icon--stripes');
            icon.textContent = ' ';
          }

          cell.appendChild(icon);
        }
        grid.appendChild(cell);
      });

      net.appendChild(grid);
      row.appendChild(net);
    });

    cv.appendChild(row);
  }

  function renderGraphsCard(cv){
    const row = document.createElement('div');
    row.className = 'graphs-row';

    function createGraphCard(labelText, pathType){
      const card = document.createElement('div');
      card.className = 'graph-card';
      const label = document.createElement('div');
      label.className = 'graph-label';
      label.textContent = labelText;
      card.appendChild(label);

      const canvas = document.createElement('div');
      canvas.className = 'graph-canvas';

      const svgNS = 'http://www.w3.org/2000/svg';
      const svg = document.createElementNS(svgNS, 'svg');
      svg.classList.add('graph-svg');
      svg.setAttribute('viewBox', '0 0 100 60');

      const axisX = document.createElementNS(svgNS, 'line');
      axisX.setAttribute('x1','10');
      axisX.setAttribute('y1','50');
      axisX.setAttribute('x2','95');
      axisX.setAttribute('y2','50');
      axisX.setAttribute('class','graph-axis');
      svg.appendChild(axisX);

      const axisY = document.createElementNS(svgNS, 'line');
      axisY.setAttribute('x1','10');
      axisY.setAttribute('y1','50');
      axisY.setAttribute('x2','10');
      axisY.setAttribute('y2','10');
      axisY.setAttribute('class','graph-axis');
      svg.appendChild(axisY);

      for (let i = 1; i <= 3; i++){
        const gx = document.createElementNS(svgNS, 'line');
        gx.setAttribute('x1', String(10 + i*20));
        gx.setAttribute('y1','50');
        gx.setAttribute('x2', String(10 + i*20));
        gx.setAttribute('y2','12');
        gx.setAttribute('class','graph-grid');
        svg.appendChild(gx);

        const gy = document.createElementNS(svgNS, 'line');
        gy.setAttribute('x1','12');
        gy.setAttribute('y1', String(50 - i*10));
        gy.setAttribute('x2','95');
        gy.setAttribute('y2', String(50 - i*10));
        gy.setAttribute('class','graph-grid');
        svg.appendChild(gy);
      }

      const path = document.createElementNS(svgNS, 'path');
      if (pathType === 'A'){
        path.setAttribute('d','M 12 46 L 35 40 L 60 32 L 90 20');
        path.setAttribute('class','graph-path-a');
      } else {
        path.setAttribute('d','M 12 44 L 40 44 L 55 42 L 70 34 L 90 18');
        path.setAttribute('class','graph-path-b');
      }
      svg.appendChild(path);

      canvas.appendChild(svg);
      card.appendChild(canvas);
      return card;
    }

    const gA = createGraphCard('График A', 'A');
    const gB = createGraphCard('График B', 'B');

    row.appendChild(gA);
    row.appendChild(gB);
    cv.appendChild(row);
  }

  function renderRouteCard(cv){
    const grid = document.createElement('div');
    grid.className = 'grid';

    const rows = 5, cols = 7;
    const blocks = new Set([
      '1-2','1-3','1-4',
      '2-2',
      '3-2','3-3','3-4'
    ]);
    const start = '4-0';
    const finish = '2-6';

    for(let r=0;r<rows;r++){
      for(let c=0;c<cols;c++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        const key = String(r) + '-' + String(c);
        if (blocks.has(key)) cell.classList.add('block');
        if (key===start) cell.classList.add('start');
        if (key===finish) cell.classList.add('finish');
        grid.appendChild(cell);
      }
    }
    cv.appendChild(grid);

    const legend = document.createElement('div');
    legend.className = 'route-legend';

    function addLegendItem(cls, text){
      const item = document.createElement('div');
      item.className = 'route-legend-item';
      const dot = document.createElement('div');
      dot.className = 'route-dot ' + cls;
      const span = document.createElement('span');
      span.textContent = text;
      item.appendChild(dot);
      item.appendChild(span);
      legend.appendChild(item);
    }

    addLegendItem('start','старт (общежитие)');
    addLegendItem('finish','финиш (лаборатория)');
    addLegendItem('block','препятствие');

    cv.appendChild(legend);
  }

  /* НОВАЯ КАРТОЧКА С ФИГУРАМИ ПО ТИПУ ФРУКТОВОЙ ЗАГАДКИ */
  function renderShapesEquationCard(cv){
    const container = document.createElement('div');
    container.className = 'shapes-eq';

    function row(elements){
      const r = document.createElement('div');
      r.className = 'shapes-eq-row';
      elements.forEach(el=>r.appendChild(el));
      return r;
    }
    function eqSymbol(text){
      const s = document.createElement('div');
      s.className = 'eq-symbol';
      s.textContent = text;
      return s;
    }
    function eqNumber(num){
      const s = document.createElement('div');
      s.className = 'eq-number';
      s.textContent = String(num);
      return s;
    }

    function makeSquare(){
      const d = document.createElement('div');
      d.className = 'shape-icon';
      const sq = document.createElement('div');
      sq.className = 'shape-square-big';
      d.appendChild(sq);
      return d;
    }
    function makeTriStack(count, small){
      const d = document.createElement('div');
      d.className = 'shape-icon shape-tri-stack';
      for(let i=0;i<count;i++){
        const t = document.createElement('div');
        t.className = 'shape-tri' + (small ? ' shape-tri-small' : '');
        d.appendChild(t);
      }
      return d;
    }
    function makeHexPair(){
      const d = document.createElement('div');
      d.className = 'shape-icon shape-hex-pair';
      const h1 = document.createElement('div');
      h1.className = 'shape-hex';
      const h2 = document.createElement('div');
      h2.className = 'shape-hex';
      d.appendChild(h1);
      d.appendChild(h2);
      return d;
    }
    function makeHexHalf(){
      const d = document.createElement('div');
      d.className = 'shape-icon';
      const h = document.createElement('div');
      h.className = 'shape-hex-half';
      d.appendChild(h);
      return d;
    }

    /* 1) три квадрата */
    const row1 = row([
      makeSquare(),
      eqSymbol('+'),
      makeSquare(),
      eqSymbol('+'),
      makeSquare(),
      eqSymbol('='),
      eqNumber(24)
    ]);

    /* 2) квадрат + две одинаковые стопки треугольников */
    const row2 = row([
      makeSquare(),
      eqSymbol('+'),
      makeTriStack(3,false),
      eqSymbol('+'),
      makeTriStack(3,false),
      eqSymbol('='),
      eqNumber(20)
    ]);

    /* 3) стопка треугольников минус пара шестиугольников */
    const row3 = row([
      makeTriStack(3,false),
      eqSymbol('−'),
      makeHexPair(),
      eqSymbol('='),
      eqNumber(2)
    ]);

    /* 4) один шестиугольник + квадрат + уменьшенная стопка треугольников = ? */
    const row4 = row([
      makeHexHalf(),
      eqSymbol('+'),
      makeSquare(),
      eqSymbol('+'),
      makeTriStack(1,true),
      eqSymbol('='),
      eqNumber('?')
    ]);

    container.appendChild(row1);
    container.appendChild(row2);
    container.appendChild(row3);
    container.appendChild(row4);

    const caption = document.createElement('div');
    caption.className = 'muted shapes-caption';
    caption.textContent = 'Первые три строки задают значения фигур. В последней строке нужно вычислить итоговое число и вписать его в ответ.';
    container.appendChild(caption);

    cv.appendChild(container);
  }

  function renderMatrixCard(cv){
    const matrix = document.createElement('div');
    matrix.className = 'matrix';
    const vals = [
      '2','4','6',
      '3','5','7',
      '4','6','?'
    ];
    vals.forEach(v=>{
      const cell = document.createElement('div');
      cell.className = 'matrix-cell' + (v==='?' ? ' question' : '' );
      cell.textContent = v;
      matrix.appendChild(cell);
    });
    cv.appendChild(matrix);
  }

  function handleReveal(m){
    if (timerId) clearInterval(timerId);
    $('rnum2').textContent = m.round;
    $('cat2').textContent = m.category;
    $('qtext2').textContent = m.prompt;

    const correctEl = $('correct');
    if (m.qtype === 'mcq'){
      correctEl.textContent = m.correctText ? 'Правильный вариант: ' + m.correctText : 'Правильный вариант обозначен администратором.';
    }else{
      if (m.mode === 'card' && Array.isArray(m.accepted) && m.accepted[0] === '*'){
        correctEl.textContent = 'Открытый ответ: оценивается по правилам карточки и логике решения.';
      }else{
        const acc = m.accepted || [];
        correctEl.textContent = acc.length
          ? 'Принятые ответы: ' + acc.join(', ')
          : 'Ответы проверяются администратором.';
      }
    }

    const resUl = $('results');
    resUl.innerHTML = '';
    (m.results || []).forEach(r=>{
      let ans = (r.text || '').trim();
      if (m.qtype === 'mcq'){
        const opts = m.options || [];
        if (r.choice != null && opts[r.choice] != null){
          ans = opts[r.choice];
        }else{
          ans = '—';
        }
      }
      const li = document.createElement('li');
      li.innerHTML = '<b>' + escapeHtml(r.name) + '</b>: ' + escapeHtml(ans) +
        ' — ' + (r.isCorrect ? 'верно' : 'неверно') + ' (+' + String(r.awarded) + ')';
      resUl.appendChild(li);
    });

    const scoresUl = $('scores');
    scoresUl.innerHTML = '';
    (m.scores || []).forEach(s=>{
      const li = document.createElement('li');
      li.innerHTML = '<b>' + escapeHtml(s.name) + '</b>: ' + String(s.score);
      scoresUl.appendChild(li);
    });

    const mine = (m.results || []).find(r=>r.playerId === playerId);
    if (mine){
      let ans = (mine.text || '').trim();
      if (m.qtype === 'mcq'){
        const opts = m.options || [];
        if (mine.choice != null && opts[mine.choice] != null){
          ans = opts[mine.choice];
        }else{
          ans = '—';
        }
      }
      myHistory.push({
        round: m.round,
        category: m.category,
        prompt: m.prompt,
        answer: ans,
        isCorrect: !!mine.isCorrect,
        awarded: mine.awarded || 0,
        timeMs: mine.timeMs
      });
    }

    show('reveal');
  }

  function handleFinal(m){
    if (timerId) clearInterval(timerId);
    const fs = $('fscores');
    fs.innerHTML = '';
    (m.scores || []).sort((a,b)=>(b.score||0)-(a.score||0)).forEach(s=>{
      const li = document.createElement('li');
      li.innerHTML = '<b>' + escapeHtml(s.name) + '</b>: ' + String(s.score);
      fs.appendChild(li);
    });

    const body = $('myHistoryBody');
    body.innerHTML = '';
    myHistory.sort((a,b)=>a.round - b.round).forEach(h=>{
      const tr = document.createElement('tr');

      const tdRound = document.createElement('td');
      tdRound.textContent = String(h.round);
      tr.appendChild(tdRound);

      const tdCat = document.createElement('td');
      tdCat.textContent = h.category;
      tr.appendChild(tdCat);

      const tdPrompt = document.createElement('td');
      const preview = (h.prompt || '').length > 80
        ? h.prompt.slice(0,77) + '...'
        : (h.prompt || '');
      tdPrompt.textContent = preview;
      tr.appendChild(tdPrompt);

      const tdAns = document.createElement('td');
      tdAns.textContent = h.answer || '—';
      tr.appendChild(tdAns);

      const tdStatus = document.createElement('td');
      tdStatus.textContent = h.isCorrect ? 'верно' : 'неверно';
      tdStatus.className = h.isCorrect ? 'status-ok' : 'status-bad';
      tr.appendChild(tdStatus);

      const tdScore = document.createElement('td');
      tdScore.textContent = '+' + String(h.awarded || 0);
      tr.appendChild(tdScore);

      const tdTime = document.createElement('td');
      if (h.timeMs != null){
        const seconds = h.timeMs/1000;
        tdTime.textContent = seconds.toFixed(1) + ' с';
      }else{
        tdTime.textContent = '—';
      }
      tr.appendChild(tdTime);

      body.appendChild(tr);
    });

    show('final');
  }

  function escapeHtml(s){
    return String(s)
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;');
  }
</script>
</body>
</html>
